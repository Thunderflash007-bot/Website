<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Bereich</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Passwortschutz und Geräte-ID-Überprüfung für die Admin-Seite
        document.addEventListener('DOMContentLoaded', () => {
            const adminPassword = '2q-tth'; // Admin-Bereich Passwort
            const allowedDeviceId = localStorage.getItem('verifiedDeviceId'); // Verifizierte Geräte-ID
            const userPassword = prompt('Bitte geben Sie das Admin-Passwort ein:');
            const userDeviceId = localStorage.getItem('deviceId');

            if (userPassword !== adminPassword || userDeviceId !== allowedDeviceId) {
                alert('Falsches Passwort oder Gerät nicht verifiziert! Zugriff verweigert.');
                window.location.href = 'index.html';
            }
        });
    </script>
</head>
<body>
<header>
    <h1>Admin Bereich</h1>
    <nav>
        <ul>
            <li><a href="index.html">Startseite</a></li>
            <li><a href="admin.html">Admin</a></li>
            <li><a href="admin-messages.html">Nachrichten</a></li>
        </ul>
    </nav>
</header>
<main>
    <section>
        <h2>Projektverwaltung</h2>
        <button id="projekt-erstellen-btn" onclick="createProject()">+ Projekt erstellen</button>
        <ul id="projekt-liste"></ul>
    </section>
    <section>
        <h2>Umfragenverwaltung</h2>
        <form id="poll-form">
            <label for="poll-question">Frage:</label>
            <input type="text" id="poll-question" placeholder="Frage eingeben" required>
            <div id="poll-options-container">
                <label>Antworten:</label>
                <div class="poll-option">
                    <input type="text" name="poll-option" placeholder="Antwort eingeben" required>
                </div>
            </div>
            <button type="button" id="add-option-btn">Weitere Antwort hinzufügen</button>
            <label>
                <input type="checkbox" id="allow-custom-answer"> Individuelle Antwort erlauben
            </label>
            <label>
                <input type="checkbox" id="allow-multiple"> Mehrfachauswahl erlauben
            </label>
            <button type="submit">Umfrage erstellen</button>
        </form>
        <ul id="poll-liste">
            <!-- Umfragen werden hier angezeigt -->
        </ul>
        <div id="poll-results">
            <h3>Abstimmungsergebnisse</h3>
            <ul id="results-liste">
                <!-- Ergebnisse werden hier angezeigt -->
            </ul>
        </div>
    </section>
    <section>
        <h2>Neuigkeitenverwaltung</h2>
        <form id="news-form">
            <label for="news-title">Titel:</label>
            <input type="text" id="news-title" placeholder="Titel eingeben" required>
            <label for="news-content">Inhalt:</label>
            <textarea id="news-content" placeholder="Inhalt eingeben" required></textarea>
            <button type="submit">Neuigkeit hinzufügen</button>
        </form>
        <ul id="news-liste">
            <!-- Neuigkeiten werden hier angezeigt -->
        </ul>
    </section>
    <section>
        <h2>"Über Uns" bearbeiten</h2>
        <form id="about-form">
            <label for="about-text">Text:</label>
            <textarea id="about-text" placeholder="Text für 'Über Uns' eingeben" required></textarea>
            <button type="submit">Speichern</button>
        </form>
    </section>
    <section>
        <h2>Admin-E-Mail ändern</h2>
        <form id="email-form">
            <label for="admin-email">Neue E-Mail-Adresse:</label>
            <input type="email" id="admin-email" placeholder="z. B. admin@tth-projects.de" required>
            <button type="submit">Speichern</button>
        </form>
    </section>
    <section>
        <h2>Datenschutzerklärung bearbeiten</h2>
        <form id="privacy-form">
            <label for="privacy-intro">Einleitung:</label>
            <textarea id="privacy-intro" placeholder="Einleitung eingeben" required></textarea>
            <label for="privacy-data">Welche Daten speichern wir?</label>
            <textarea id="privacy-data" placeholder="Datenbeschreibung eingeben" required></textarea>
            <label for="privacy-storage">Wie und wo speichern wir Ihre Daten?</label>
            <textarea id="privacy-storage" placeholder="Speicherortbeschreibung eingeben" required></textarea>
            <label for="privacy-access">Wer hat Zugriff auf Ihre Daten?</label>
            <textarea id="privacy-access" placeholder="Zugriffsbeschreibung eingeben" required></textarea>
            <label for="privacy-sharing">Weitergabe an Dritte:</label>
            <textarea id="privacy-sharing" placeholder="Weitergabebeschreibung eingeben" required></textarea>
            <label for="privacy-rights">Ihre Rechte:</label>
            <textarea id="privacy-rights" placeholder="Rechtebeschreibung eingeben" required></textarea>
            <button type="submit">Speichern</button>
        </form>
    </section>
    <section>
        <h2>Verifizierungscodes</h2>
        <button onclick="generateVerificationCode()">Neuen Code generieren</button>
        <ul id="code-liste">
            <!-- Generierte Codes werden hier angezeigt -->
        </ul>
    </section>
    <section>
        <h2>Verifizierte Geräte</h2>
        <ul id="verified-devices-list">
            <!-- Verifizierte Geräte werden hier angezeigt -->
        </ul>
        <button onclick="clearVerifiedDevices()">Alle Geräte löschen</button>
        <button onclick="addIPv6ToAllowed()">IPv6-Adresse zu erlaubten IPs hinzufügen</button>
    </section>
</main>
<footer>
    <p>Kontakt: <span id="footer-email">thunderflash@tth-projects.de</span></p>
</footer>
<script>
    // Admin-E-Mail speichern
    document.getElementById('email-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('admin-email').value;
        localStorage.setItem('adminEmail', email);
        alert('Admin-E-Mail wurde erfolgreich geändert!');
    });

    // Funktion zum Löschen aller verifizierten Geräte
    function clearVerifiedDevices() {
        if (confirm('Möchten Sie wirklich alle verifizierten Geräte löschen?')) {
            localStorage.removeItem('verifiedDevices');
            alert('Alle verifizierten Geräte wurden gelöscht.');
            displayVerifiedDevices();
        }
    }

    // Funktion zum Hinzufügen einer IPv6-Adresse im Admin-Bereich
    async function addIPv6ToAllowed() {
        const ipv6Address = prompt('Bitte geben Sie die IPv6-Adresse ein:');
        if (ipv6Address) {
            try {
                const response = await fetch('/allowed_ips.json');
                const allowedIps = await response.json();

                if (!allowedIps.some(ipEntry => ipEntry.ip === ipv6Address)) {
                    allowedIps.push({ ip: ipv6Address, requiresPassword: false, password: null });
                    await fetch('/allowed_ips.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(allowedIps, null, 2),
                    });
                    alert('IPv6-Adresse erfolgreich hinzugefügt!');
                } else {
                    alert('Diese IPv6-Adresse ist bereits erlaubt.');
                }
            } catch (error) {
                console.error('Fehler beim Hinzufügen der IPv6-Adresse:', error);
            }
        } else {
            alert('Keine IPv6-Adresse eingegeben.');
        }
    }

    // Funktion zum Verifizieren über IPv6
    async function verifyIPv6() {
        const ipv6Address = await fetchIPv6Address();
        if (ipv6Address) {
            const encryptedDevices = JSON.parse(localStorage.getItem('verifiedDevices')) || [];
            const encryptedIPv6 = btoa(ipv6Address); // IPv6-Adresse verschlüsseln
            if (!encryptedDevices.includes(encryptedIPv6)) {
                encryptedDevices.push(encryptedIPv6);
                localStorage.setItem('verifiedDevices', JSON.stringify(encryptedDevices));
                alert('IPv6-Adresse erfolgreich verifiziert!');
            } else {
                alert('Diese IPv6-Adresse ist bereits verifiziert.');
            }
            displayVerifiedDevices();
        } else {
            alert('IPv6-Adresse konnte nicht ermittelt werden.');
        }
    }

    // Funktion zum Verschlüsseln von Daten
    function encryptData(data) {
        return btoa(data); // Base64-Verschlüsselung (Beispiel)
    }

    // Funktion zum Entschlüsseln von Daten
    function decryptData(data) {
        return atob(data); // Base64-Entschlüsselung (Beispiel)
    }

    // Funktion zum Abrufen der IPv6-Adresse
    async function fetchIPv6Address() {
        try {
            const response = await fetch('https://api64.ipify.org?format=json');
            const { ip } = await response.json();
            return ip; // IPv6-Adresse
        } catch (error) {
            console.error('Fehler beim Abrufen der IPv6-Adresse:', error);
            return null;
        }
    }

    // Funktion zum Anzeigen der verifizierten Geräte
    async function displayVerifiedDevices() {
        const encryptedDevices = JSON.parse(localStorage.getItem('verifiedDevices')) || [];
        const verifiedDevicesList = document.getElementById('verified-devices-list');
        verifiedDevicesList.innerHTML = '';

        if (encryptedDevices.length > 0) {
            encryptedDevices.forEach((encryptedDevice, index) => {
                const li = document.createElement('li');
                li.textContent = `Gerät ${index + 1}: ${decryptData(encryptedDevice)}`;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Löschen';
                deleteButton.onclick = () => {
                    encryptedDevices.splice(index, 1);
                    localStorage.setItem('verifiedDevices', JSON.stringify(encryptedDevices));
                    displayVerifiedDevices();
                };
                li.appendChild(deleteButton);
                verifiedDevicesList.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'Keine verifizierten Geräte gefunden.';
            verifiedDevicesList.appendChild(li);
        }
    }

    // Initialer Verifizierungscode setzen
    document.addEventListener('DOMContentLoaded', () => {
        const validCodes = JSON.parse(localStorage.getItem('validCodes')) || [];
        if (!validCodes.includes('2q')) {
            validCodes.push('2q');
            localStorage.setItem('validCodes', JSON.stringify(validCodes));
        }
        displayVerifiedDevices();
    });

    // Projekte abrufen und anzeigen
    async function fetchProjects() {
        try {
            const response = await fetch('/projects.json');
            const projects = await response.json();
            const projektListe = document.getElementById('projekt-liste');
            projektListe.innerHTML = '';
            projects.forEach(project => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${project.name}</strong>: ${project.description}
                    <p>Status: ${getStatusText(project.status)}</p>
                    <button onclick="editProject('${project.id}')">Bearbeiten</button>
                    <button onclick="deleteProject('${project.id}')">Löschen</button>
                `;
                projektListe.appendChild(li);
            });
        } catch (error) {
            console.error('Fehler beim Abrufen der Projekte:', error);
        }
    }

    // Projekt bearbeiten
    async function editProject(id) {
        try {
            const response = await fetch('/projects.json');
            const projects = await response.json();
            const project = projects.find(p => p.id === id);

            if (project) {
                const newName = prompt('Neuer Name:', project.name);
                const newDescription = prompt('Neue Beschreibung:', project.description);
                const newStatus = prompt('Neuer Status (online/offline):', project.status);

                if (newName && newDescription && newStatus) {
                    project.name = newName;
                    project.description = newDescription;
                    project.status = newStatus;

                    const updatedProjects = projects.map(p => (p.id === id ? project : p));
                    await fetch('/projects.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedProjects)
                    });

                    alert('Projekt erfolgreich bearbeitet!');
                    fetchProjects();
                } else {
                    alert('Bearbeitung abgebrochen. Bitte geben Sie alle Informationen ein.');
                }
            } else {
                alert('Projekt nicht gefunden.');
            }
        } catch (error) {
            console.error('Fehler beim Bearbeiten des Projekts:', error);
        }
    }

    // Synchronisierungslogik
    async function syncData() {
        try {
            const response = await fetch('/sync', { method: 'POST' });
            if (response.ok) {
                console.log('Daten erfolgreich synchronisiert.');
            } else {
                console.error('Fehler bei der Synchronisierung.');
            }
        } catch (error) {
            console.error('Fehler bei der Synchronisierung:', error);
        }
    }

    // Synchronisierung nach jeder Aktion
    async function handleSyncAfterAction(action) {
        await action();
        await syncData();
    }

    // Beispiel: Projekt erstellen mit Synchronisierung
    async function createProject() {
        const projectName = prompt('Bitte geben Sie den Projektnamen ein:');
        const projectDescription = prompt('Bitte geben Sie die Projektbeschreibung ein:');
        if (projectName && projectDescription) {
            const newProject = {
                id: Date.now().toString(),
                name: projectName,
                description: projectDescription,
                status: 'offline'
            };
            try {
                const response = await fetch('/projects.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newProject)
                });
                if (response.ok) {
                    alert('Projekt erfolgreich erstellt!');
                    await handleSyncAfterAction(fetchProjects);
                } else {
                    alert('Fehler beim Erstellen des Projekts.');
                }
            } catch (error) {
                console.error('Fehler beim Erstellen des Projekts:', error);
            }
        } else {
            alert('Projekterstellung abgebrochen. Bitte geben Sie alle Informationen ein.');
        }
    }

    // Projekt löschen
    async function deleteProject(id) {
        try {
            const response = await fetch(`/projects.json?id=${id}`, { method: 'DELETE' });
            if (response.ok) {
                alert('Projekt erfolgreich gelöscht!');
                fetchProjects();
            } else {
                alert('Fehler beim Löschen des Projekts.');
            }
        } catch (error) {
            console.error('Fehler beim Löschen des Projekts:', error);
        }
    }

    // Status-Text mit Emoji basierend auf dem Status zurückgeben
    function getStatusText(status) {
        if (status === 'online') {
            return 'Online ✅';
        } else if (status === 'offline') {
            return 'Offline ❌';
        } else {
            return 'Unbekannt ❓';
        }
    }

    // Projekt speichern (neu oder aktualisieren)
    function saveProject(project) {
        const projects = JSON.parse(localStorage.getItem('projects')) || [];
        const existingIndex = projects.findIndex(p => p.id === project.id);

        if (existingIndex !== -1) {
            projects[existingIndex] = project;
        } else {
            projects.push(project);
        }

        localStorage.setItem('projects', JSON.stringify(projects));
        alert('Projekt erfolgreich gespeichert!');
        fetchProjects();
    }

    // Verifizierungscode generieren
    function generateVerificationCode() {
        const newCode = prompt('Bitte geben Sie den neuen Verifizierungscode ein:');
        if (newCode) {
            const validCodes = JSON.parse(localStorage.getItem('validCodes')) || [];
            validCodes.push(newCode);
            localStorage.setItem('validCodes', JSON.stringify(validCodes));
            alert('Neuer Code generiert: ' + newCode);
            displayCodes();
        }
    }

    function displayCodes() {
        const validCodes = JSON.parse(localStorage.getItem('validCodes')) || [];
        const codeListe = document.getElementById('code-liste');
        codeListe.innerHTML = '';
        validCodes.forEach(code => {
            const li = document.createElement('li');
            li.textContent = code;
            codeListe.appendChild(li);
        });
    }

    document.addEventListener('DOMContentLoaded', displayCodes);

    // Datenschutzerklärung laden
    async function loadPrivacySections() {
        try {
            const response = await fetch('/privacy.json');
            const privacyData = await response.json();
            document.getElementById('privacy-intro').value = privacyData.intro || '';
            document.getElementById('privacy-data').value = privacyData.data || '';
            document.getElementById('privacy-storage').value = privacyData.storage || '';
            document.getElementById('privacy-access').value = privacyData.access || '';
            document.getElementById('privacy-sharing').value = privacyData.sharing || '';
            document.getElementById('privacy-rights').value = privacyData.rights || '';
        } catch (error) {
            console.error('Fehler beim Laden der Datenschutzerklärung:', error);
        }
    }

    // Datenschutzerklärung speichern
    document.getElementById('privacy-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedPrivacy = {
            intro: document.getElementById('privacy-intro').value,
            data: document.getElementById('privacy-data').value,
            storage: document.getElementById('privacy-storage').value,
            access: document.getElementById('privacy-access').value,
            sharing: document.getElementById('privacy-sharing').value,
            rights: document.getElementById('privacy-rights').value,
        };

        try {
            const response = await fetch('/privacy.json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedPrivacy),
            });

            if (response.ok) {
                alert('Datenschutzerklärung erfolgreich aktualisiert!');
                await syncData();
            } else {
                alert('Fehler beim Speichern der Datenschutzerklärung.');
            }
        } catch (error) {
            console.error('Fehler beim Speichern der Datenschutzerklärung:', error);
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchProjects();
        await syncData();
    });
</script>
</body>
</html>
